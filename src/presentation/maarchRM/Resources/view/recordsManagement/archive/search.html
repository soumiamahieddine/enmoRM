<!--#
    This file is part of the registeredMail package.
    (c) Maarch Alexis Ragot <alexis.ragot@maarch.org>

    For the full copyright and license information, please view the LICENSE
    file that was distributed with this source code.
#-->
<div id="contain" >
    <div class="container-fluid" data-translate-catalog="recordsManagement/messages">
        <div class="page-header">
            <h1>
                <i class="fa fa-search"></i>
                Search archives
            </h1>
        </div>
    </div>

    <div class="container-fluid" lang="en" data-translate-catalog="recordsManagement/messages">
        <?merge emptyRole ?>
        <h3><i class="fa fa-times"></i> You have to choose a working organization unit to proceed this action.</h3>
        <?merge emptyRole.not() ?>
        <div class="panel-group" id="accordionSearch">
            <div class="panel panel-default">
                <div class="panel-heading" data-toggle="collapse" data-parent="#accordionSearch" href="#collapseOne" style="cursor:pointer;">
                    <h4 class="panel-title" style="float:left;">
                        Search form
                    </h4>
                    <i class="fa fa-caret-down" style="float:right;"></i>
                    <div style="clear:both;"></div>
                </div>
                <div id="collapseOne" class="well panel-collapse collapse in" style="margin-bottom: 0px">
                    <form class="form-horizontal" id="archive_searchForm">
                        <input type="hidden" name="maxResults" id="maxResults" value="[?merge maxResults ?]"/>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Archive identifier</label>
                                <div class="col-sm-6">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="archive_archiveIdentifier" name="archiveIdentifier" placeholder="Archive identifier"/>
                                        <div class="input-group-btn">
                                            <button type="button" class="btn btn-default" id="archive_searchByIdentifier" title="Search">Search</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <hr/>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Fulltext</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" name="text" placeholder="Fulltext"/>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Archival profile</label>
                                    <div class="col-sm-6">
                                        <select class="form-control" name="profileReference">
                                            <option value="">All</option>
                                            <?merge profiles ?>
                                            <option value="[?merge .reference ?]"><?merge .name ?></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Status</label>
                                    <div class="col-sm-6">
                                        <select class="form-control" name="status">
                                            <option value="">All</option>
                                            <option value="preserved">Preserved</option>
                                            <option value="frozen">Frozen</option>
                                            <option value="disposable">Waiting for destruction</option>
                                            <option value="error">Error</option>
                                            <?merge deleteDescription.bool().not() ?>
                                            <option value="disposed">Disposed</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Retention rule</label>
                                    <div class="col-sm-6">
                                        <select class="form-control" name="retentionRuleCode">
                                            <option value="">All</option>
                                            <?merge retentionRules ?>
                                            <option value="[?merge .code ?]"><?merge .label ?></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Final disposition</label>
                                    <div class="col-sm-6">
                                        <select class="form-control" name="finalDisposition">
                                            <option value="">All</option>
                                            <option value="preservation">Preservation</option>
                                            <option value="destruction">Destruction</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Producer</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control orgHide" placeholder="Producer"  name="orgTypeahead" id="orgTypeahead"/>
                                        <select class="form-control hide" name="originatorOwnerOrgId" id="originatorOwnerOrgId">
                                            <option value="">All</option>
                                            <?merge organizationsOriginator ?>
                                            <option value="[?merge .orgId ?]"><?merge .displayName ?></option>
                                        </select>
                                        <select class="form-control hide" name="originatorOrgRegNumber" id="originatorOrgRegNumber">
                                            <option value="">All</option>
                                            <?merge organizationsOriginator ?>
                                            <div>
                                                <?merge .originators ?>
                                                <option value="[?merge .registrationNumber ?]" orgId="[?merge .ownerOrgId ?]"><?merge .displayName ?></option>
                                            </div>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group" id="originatorOrgInfo">
                                    <label class="col-sm-4 control-label">Organization</label>
                                        <span class="col-sm-6 align-middle" id="originatorOwnerOrgName"></span>
                                </div>
                                <br/>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Deposit date</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control datePicker" name="depositStartDate" placeholder="From date"/>
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control datePicker" name="depositEndDate" placeholder="To date"/>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Originating date</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control datePicker" name="originatingStartDate" placeholder="From date"/>
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control datePicker" name="originatingEndDate" placeholder="To date"/>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">DAU</label>
                                    <div class="btn-group col-sm-6" data-toggle="buttons">
                                        <label class="btn btn-info active archiveExpired" title="All">
                                            <input type="radio" name="archiveExpired" value="" checked/> All
                                        </label>
                                        <label class="btn btn-default archiveExpired" title="Not expired">
                                            <input type="radio" name="archiveExpired" value="false"/> Not expired
                                        </label>
                                        <label class="btn btn-default archiveExpired" title="Expired">
                                            <input type="radio" name="archiveExpired" value="true"/> Expired
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Partial retention rule</label>
                                    <div class="col-sm-6">
                                        <input type="checkbox"  name="partialRetentionRule" data-toggle="toggle"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br/>
                        <div class="clearfix">
                            <div class="col-md-12">
                                <button type="button" class="btn btn-primary col-md-offset-4 col-md-3" id="archive_search" title="Search"><i class="fa fa-search">&nbsp;</i>Search</button>
                                <button type="button" class="btn btn-warning col-md-offset-1" id="archive_resetForm" title="Reset"><i class="fa fa-refresh">&nbsp;</i>Reset</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Error message -->
        <div class="hide" id="errorMessage">You must enter a profile and at least a date (maximum and/or minimum)</div>

        <!-- Message usage -->
        <input type="hidden" id="useRestitutionMessages" value="[?merge useRestitutionMessages ?]">
        <input type="hidden" id="useDestructionMessages" value="[?merge useDestructionMessages ?]">
        <span  class="hide" id="noOriginatorFound">No originator found</span>

        <div class="container-fluid" id="archive_searchResult"></div>
    </div>

    <div class="modal fade bs-example-modal-lg" id="corruptedModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="container_corruptedModal">
            </div>
        </div>
    </div>
</div>
<script src="/public/js/bootstrap-toggle/bootstrap-toggle.js"></script>
<script>
    $("#originatorOrgInfo").hide();

    /* ----------------------------------------------------------------------------------------------------*/
    /* -- SEARCH FORM -- */

    $('#app_maarchRM_main').keypress(function (e) {
        if (e.which != 13) {
            return;
        }
        // Prevent form submit
        e.preventDefault();
        if ($("#archive_archiveIdentifier").is(':focus')) {
            $("#archive_searchByIdentifier").click();

        } else {
            $("#archive_search").click();
        }
    });

    // radio button
    $("#archive_searchForm").on('click', '.archiveExpired', function () {
        $('#archive_searchForm').find('.archiveExpired').removeClass('btn-info').addClass('btn-default');
        $(this).addClass('btn-info');
    })

    $('#archive_searchByIdentifier').on('click', function () {
        if ($('#archive_archiveIdentifier').val().trim() == "") {
            return;
        }

        ajax($(this), {
            type        : 'GET',
            url         : '/recordsManagement/archives',
            data        : { archiveId: $('#archive_archiveIdentifier').val().trim() },
            dataType    : 'html',
            success     : function (response) {
                $('#archive_searchResult').empty().html(response);
            },
            error       : function (e) {
            }
        });
    });

    $('#archive_search').on('click', function () {

        $('#archive_search').prop('disabled', true);
        $('#archive_searchForm').find('[name="archiveIdentifier"]').val('');

        $.ajax({
            type     : 'GET',
            url      : '/recordsManagement/archives',
            //data     : $("#archive_searchForm").serialize(),
            data     : searchFormSerialize(),
            dataType : 'html',
            success  : function (response) {
                $('#archive_searchResult').empty().html(response);
                $('#archive_search').prop('disabled', false);
            },
            error    : function(response) {
                response = JSON.parse(response.responseText);
                gritter.show(response.message);
                $('#archive_search').prop('disabled', false);
            }
        });
    });

    $("#archive_resetForm").on("click", function () {
        $('#archive_searchForm').find('input[type="text"], select').val('');
        $('#archive_searchForm').find("input[name='archiveExpired'][value='']").parent().click();
        $('#archive_searchForm').find('input[type="checkbox"]').bootstrapToggle('off');
        $('#originatorOrgInfo').hide();

        delete $("#archive_searchForm [name=depositStartDate]").data('datepicker').setDates();
        delete $("#archive_searchForm [name=depositEndDate]").data('datepicker').setDates();
        delete $("#archive_searchForm [name=originatingStartDate]").data('datepicker').setDates();
        delete $("#archive_searchForm [name=originatingEndDate]").data('datepicker').setDates();

        $('#archive_searchResult').empty();
    });

    function searchFormSerialize() {
        var parameters = new Object();

        $('#archive_searchForm').find('input[type="text"], input[type="hidden"], input[type="number"], select').each(function(){

            if(!$(this).hasClass('orgHide')) {
                parameters[$(this).attr('name')] = $(this).val();
            }
        });
        $('#archive_searchForm').find('input[type="checkbox"]').each(function(){
            parameters[$(this).attr('name')] = $(this).prop("checked");
        });
        parameters.archiveExpired = $("#archive_searchForm [name=archiveExpired]:checked").val();
        parameters.depositStartDate = $("#archive_searchForm [name=depositStartDate]").data('datepicker').getFormattedDate('yyyy-mm-dd');
        parameters.depositEndDate = $("#archive_searchForm [name=depositEndDate]").data('datepicker').getFormattedDate('yyyy-mm-dd');
        parameters.originatingStartDate = $("#archive_searchForm [name=originatingStartDate]").data('datepicker').getFormattedDate('yyyy-mm-dd');
        parameters.originatingEndDate = $("#archive_searchForm [name=originatingEndDate]").data('datepicker').getFormattedDate('yyyy-mm-dd');

        return parameters;
    }

    /* ----------------------------------------------------------------------------------------------------*/
    /* -- VALIDATION MODAL -- */

    $("#contain").on('click', '#cancelAction', function () {
        $('#validateAction').off();
    })

    /* ----------------------------------------------------------------------------------------------------*/
    /* -- EDITION MODAL -- */

    var organizations = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('displayName'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        prefetch: {url: '/organizations/todisplay?orgUnit=true', ttl: '0'},
        limit: 100
    });

    window.localStorage.clear();
    organizations.initialize();

    // initialize typeahead
    $('#orgTypeahead').typeahead(
        {
            hint: true,
            highlight: true,
            minLength: 2
        },
        {
            name: 'organizations',
            displayKey: 'displayName',
            templates: {
                empty: function() {
                    return "<span class='well well-sm'>"+$('#noOriginatorFound').html()+"</span>";
                },
                suggestion: function(organization) {
                    var display =
                        "<span>"
                        + "<span style='font-family:Helvetica, sans-serif;'>";

                    if(organization.ownerOrgName) {
                        display += organization.ownerOrgName
                                + " > ";
                    }
                       display += organization.displayName
                        + "</span></span><br>";

                    return display;
                }
            },
            source: function(query, cb) {
                organizations.search(query, function(suggestions) {
                    var i = suggestions.length
                    while (i--) {
                        if ($('#orgs').find('[data-orgid="'+ suggestions[i].orgId +'"]').length)
                            suggestions.splice(i, 1);
                    }
                    cb(suggestions);
                });
            },
            skipCache: true
        }
    ).on('typeahead:selected', function($event, suggestion, source) {

        if(suggestion.ownerOrgId) {
            $("#originatorOrgRegNumber").val(suggestion.registrationNumber);
            $("#originatorOrgInfo").show();
            $("#originatorOwnerOrgName").html(suggestion.ownerOrgName);
            $("#originatorOwnerOrgId").val('');
        } else {
            $("#originatorOwnerOrgId").val(suggestion.orgId);
            $("#originatorOrgInfo").hide();
            $("#originatorOrgRegNumber").val('');
        }

    });

    $('#orgTypeahead').keyup(function () {

        if(!$(this).val()) {
            $("#originatorOrgInfo").hide();
        }
    });


</script>
